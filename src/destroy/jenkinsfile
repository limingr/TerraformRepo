pipeline {
    agent any
    
    parameters { text(name: 'test', defaultValue: 'wsdepploy', description: '') }
    
    environment {
        AZURE_SUBSCRIPTION_ID='aae27198-c02d-49fc-a164-d45d35267dd2'
        AZURE_TENANT_ID='e22100bd-861d-4f4c-a190-7c4f45feeccf'
        AZURE_BACKEND_STORAGE_SECRET = credentials('terraform_state_azure_backend_storage_key')
    }

    stages {
        stage('Build') {
            steps {
                echo 'Building....'
                sh 'pwd'
            }
        }
        stage('Test') {
            steps {
                withCredentials([azureServicePrincipal('AzureServicePrincipal')]) {
                    dir('.'){
                        sh """#!/bin/bash
                        set -e

                        terraform init -no-color \
                            -backend-config='storage_account_name=tstate13126' \
                            -backend-config='container_name=tstate' \
                            -backend-config='key=terraform.mytfstate' \
                            -backend-config='access_key=${AZURE_BACKEND_STORAGE_SECRET}'

                        terraform workspace new wsdeploy || true
                        terraform workspace select wsdeploy
                        terraform init -no-color \
                            -backend-config='storage_account_name=tstate13126' \
                            -backend-config='container_name=tstate' \
                            -backend-config='key=terraform.mytfstate' \
                            -backend-config='access_key=${AZURE_BACKEND_STORAGE_SECRET}'

                        terraform plan -destroy  -no-color -var client_secret='${AZURE_CLIENT_SECRET}'
                        terraform destroy -auto-approve -no-color -var client_secret='${AZURE_CLIENT_SECRET}'
 
                        sh """
                    }
                }
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying....'
            }
        }
    }
}
